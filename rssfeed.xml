name: Generate & Update RSS Feed

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 * * * *"  # Update setiap jam

jobs:
  update-rss:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install feedgen

      - name: Generate RSS Feed
        run: |
          python - <<EOF
          import os
          import glob
          from datetime import datetime
          from feedgen.feed import FeedGenerator

          # Buat RSS feed baru
          fg = FeedGenerator()
          fg.title("Insight-Nusantara")
          fg.link(href="https://premierbolagg.github.io/Insight-Nusantara/")
          fg.description("Kumpulan Artikel Terbaru 2025")
          fg.language("id")

          # Ambil semua artikel dari folder posts/
          articles = sorted(glob.glob("posts/*.md"), reverse=True)

          for article in articles:
              with open(article, "r", encoding="utf-8") as f:
                  lines = f.readlines()
                  if len(lines) < 2:
                      continue
                  title = lines[0].strip("# ").strip()
                  date_str = lines[1].strip()  # Tanggal di baris kedua
                  try:
                      date_obj = datetime.strptime(date_str, "%Y-%m-%d")
                  except ValueError:
                      print(f"❌ ERROR: Format tanggal salah di {article}, lewati file ini.")
                      continue

                  fe = fg.add_entry()
                  fe.title(title)
                  fe.link(href=f"https://premierbolagg.github.io/Insight-Nusantara/{article.replace('posts/', '').replace('.md', '.html')}")
                  fe.pubDate(date_obj)

          # Simpan ke file XML di root repo
          fg.rss_file("rssfeed.xml")
          print("✅ RSS feed berhasil diperbarui!")
          EOF

      - name: Commit & Push Changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "actions@github.com"
          git add rssfeed.xml
          git commit -m "🔄 Auto-update RSS feed" || echo "No changes to commit"
          git push origin main
